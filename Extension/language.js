const translations = {
    "EXTENSION_NAME": {
        "en": "Consent-O-Matic",
        "da": "Consent-O-Matic",
        "de": "Consent-O-Matic"
    },
    "EXTENSION_SUBTITLE": {
        "en": "Your Choice - Applied Everywhere",
        "da": "Dit valg - Anvendt overalt"
    },
    "YOUR_CHOICE": {
        "en": "Your Choice",
        "da": "Dit valg"
    },
    "RULE_LIST": {
        "en": "Rule Lists",
        "da": "Regler"
    },
    "LOG": {
        "en": "Log",
        "da": "Log"
    },
    "DEBUG": {
        "en": "Debug",
        "da": "Debug"
    },
    "CHOICE_DESCRIPTION": {
        "en": "Configure what categories of tracking you would like to allow. Consent-O-Matic then fills out consent popups as best as possible based on your preferences. All tracking is rejected by default.",
        "da": "Konfigurer hvilke tracking kategorier du gerne vil tillade. Så vil Consent-O-Matic udfylde samtykke popups så godt den kan baseret på dine valg. Som standard bliver alt tracking afvist."
    },
    "RULES_DESCRIPTION": {
        "en": "Consent-O-Matic comes with a set of rules that tell it how to understand each kind of GDPR consent popup. You can add more sources of rules here - or even create your own list and share it with others!",
        "da": "Consent-O-Matic kommer med et sæt af regler der fortæller hvordan den skal behandler hver slags GDPR samtykke popup. Du kan tilføje flere regel kilder her - eller oprette din egen liste og dele den med andre!"
    },
    "ADD_LIST": {
        "en": "Add List",
        "da": "Tilføj liste"
    },
    "RULES_UPDATE_DESCRIPTION": {
        "en": "All the rule lists are updated automatically every 15 minutes or you can",
        "da": "Alle listerne med regler opdateres automatisk hvert 15. minut, eller du kan"
    },
    "UPDATE_RULES_NOW": {
        "en": "Update Rules Now",
        "da": "Opdater regler nu"
    },
    "RULE_GENERATOR": {
        "en": "Rule List Generator",
        "da": "Regel liste generator"
    },
    "RULE_GENERATOR_DESCRIPTION": {
        "en": "As an alternative to writing JSON rules by hand it is also possible to create rules using this drag-n-drop editor:",
        "da": "Som alternativ til at skrive JSON reglerne i hånden, er det også muligt at lave regler med denne drag-n-drop editor:"
    },
    "OPEN_RULE_GENERATOR": {
        "en": "Open Rule Editor",
        "da": "Åben regel editor"
    },
    "CLEAR": {
        "en": "Clear",
        "da": "Ryd"
    },
    "LOG_DESCRIPTION": {
        "en": "This is a list of all the GDPR consent popups that were handled",
        "da": "Dette er en liste over alle GDPR samtykke popups der har været håndteret"
    },
    "CLICK_DELAY_DESCRIPTION": {
        "en": "Wait a short time between performing each action or mouse gesture",
        "da": "Vent en kort periode i mellem udførslen af hver handling eller muse gesture"
    },
    "SKIP_SUBMIT_DESCRIPTION": {
        "en": "Perform actions normally but do not submit the consent",
        "da": "Udfør handlinger normalt, men lad være med at indsende samtykket"
    },
    "PAINT_MATCHERS_DESCRIPTION": {
        "en": "Visual feedback while matching consent choices",
        "da": "Visuel feedback mens samtykke valg matches"
    },
    "DEBUG_CLICKS_DESCRIPTION": {
        "en": "Debug clicks to the log",
        "da": "Debug klik til loggen"
    },
    "ALWAYS_FORCE_UPDATE_DESCRIPTION": {
        "en": "Always force a reload of the rules on each page load",
        "da": "Tving genlæsning af reglerne ved hver side hentning"
    },
    "SKIP_HIDE_DESCRIPTION": {
        "en": "Skips the HIDE_CMP method, to better see what's going on behind the scenes.",
        "da": "Spring HIDE_CMP metoden over, for bedre at se hvad der foregår bag kulisserne."
    },
    "EXTRA_DEBUG_DESCRIPTION": {
        "en": "Enables extra debug logging",
        "da": "Aktiver ekstra debug logning"
    },
    "INFORMATION_NAME": {
        "en": "Information Storage and Access"
    },
    "INFORMATION_DESCRIPTION": {
        "en": "Storage of information or access to information that is already stored on your device - such as advertising identifiers, device identifiers, cookies, and similar technologies."
    },
    "PREFERENCES_NAME": {
        "en": "Preferences and Functionality"
    },
    "PREFERENCES_DESCRIPTION": {
        "en": "Allow sites to remember choices you make (such as your user name, language or the region you are located in) and provide enhanced, more personal features. For instance, these cookies can be used to remember your login details, changes you have made to text size, fonts and other parts of web pages that you can customize. They may also be used to provide services you have asked for such as watching a video or commenting on a blog. The information in these cookies is not used to track your browsing activity on other websites."
    },
    "PERFORMANCE_NAME": {
        "en": "Performance and Analytics"
    },
    "PERFORMANCE_DESCRIPTION": {
        "en": "The collection of information, and combination with previously collected information, to measure, understand, and report, on your usage of the services. This allows websites to count visits and traffic sources so they can measure and improve the performance of the site. It helps them know which pages are the most and least popular, see how visitors move around the site, and where visitors come from."
    },
    "CONTENT_NAME": {
        "en": "Content selection, delivery, and reporting"
    },
    "CONTENT_DESCRIPTION": {
        "en": "Collection of information, and combination with previously collected information, to select and deliver content for you, and to measure the delivery and effectiveness of such content. This includes using previously collected information about your interests to select content, processing data about what <b>content</b> was shown, how often or how long it was shown, when and where it was shown, and whether you took any action related to the content, including for example clicking on content. The data will be used to personalise content on the website itself, but also in other contexts such as other websites, apps, browsers, and devices."
    },
    "AD_NAME": {
        "en": "Ad selection, delivery, and reporting"
    },
    "AD_DESCRIPTION": {
        "en": "Collection of information, and combination with previously collected information, to select and deliver advertisements, and to measure the delivery and effectiveness of such advertisements. This includes using previously collected information about your interests to select ads, processing data about what <b>advertisements</b> were shown, how often they were shown, when and where they were shown, and whether you took any action related to the advertisement, including for example clicking an ad or making a purchase. The data will be used to personalise advertising on the website itself, but also in other contexts such as other websites, apps, browsers, and devices.<br><br>Also includes:<br>Google"
    },
    "OTHER_NAME": {
        "en": "Other Purposes"
    },
    "OTHER_DESCRIPTION": {
        "en": "Unclassified data collection for which the purpose is not clearly described by the website or where the data collection and processing does not fit any other category"
    },
    "AUTOFILL_NOT_WORKING": {
        "en": "GDPR autofill didn't work?",
        "da": "Virkede autoudfyldningen ikke?"
    },
    "LET_US_KNOW": {
        "en": "Let us know!",
        "da": "Fortæl os!"
    },
    "KEEP_RUNNING": {
        "en": "Keep running on this site?",
        "da": "Fortsæt med at køre på denne side?"
    },
    "MORE_ADDON_SETTINGS": {
        "en": "More Add-on Settings",
        "da": "Flere addon indstillinger"
    },
    "EDITOR_HEADER": {
        "en": "GDPR Consent Rule Editor",
        "da": "GDPR samtykke regel editor"
    },
    "MENU": {
        "en": "Menu",
        "da": "Menu"
    },
    "BACK": {
        "en": "Back",
        "da": "Tilbage"
    },
    "SAVE_CUSTOM_RULE": {
        "en": "Save Custom Rule"
    },
    "EXPORT_JSON": {
        "en": "Export Json",
        "da": "Eksporter json"
    },
    "COLLAPSE_ALL": {
        "en": "Collapse All"
    },
    "UNCOLLAPSE_ALL": {
        "en": "Uncollapse All"
    },
    "DRAGGABLE_ELEMENTS": {
        "en": "Draggable Elements"
    },
    "DETECTOR": {
        "en": "Detector"
    },
    "CSS_MATCHER": {
        "en": "CssMatcher"
    },
    "CHECKBOX_MATCHER": {
        "en": "CheckboxMatcher"
    },
    "CLICK_ACTION": {
        "en": "ClickAction"
    },
    "CONSENT_ACTION": {
        "en": "ConsentAction"
    },
    "LIST_ACTION": {
        "en": "ListAction"
    },
    "WAIT_CSS_ACTION": {
        "en": "WaitCssAction"
    },
    "IF_CSS_ACTION": {
        "en": "IfCssAction"
    },
    "FOR_EACH_ACTION": {
        "en": "ForEachAction"
    },
    "SLIDE_ACTION": {
        "en": "SlideAction"
    },
    "CLOSE_ACTION": {
        "en": "CloseAction"
    },
    "HIDE_ACTION": {
        "en": "HideAction"
    },
    "WAIT_ACTION": {
        "en": "WaitAction"
    },
    "CONSENT": {
        "en": "Consent",
        "da": "Samtykke"
    },
    "DOM_SELECTOR": {
        "en": "DomSelector"
    },
    "TRASH": {
        "en": "Trash",
        "da": "Papirkurv"
    },
    "LOAD_RULES": {
        "en": "Load Rules",
        "da": "Indlæs regler"
    },
    "FROM_PLUGIN_SOURCE": {
        "en": "From Plugin Sources",
        "da": "Fra plugin kilder"
    },
    "LOAD": {
        "en": "Load",
        "da": "Indlæs"
    },
    "FROM_CUSTOM_RULES": {
        "en": "From Your Custom Rules",
        "da": "Fra dine brugerdefinerede regler"
    },
    "DELETE": {
        "en": "Delete",
        "da": "Slet"
    },
    "FROM_PASTED_JSON": {
        "en": "From Pasted JSON",
        "da": "Fra indsat json"
    },
    "CREATE_FROM_SCRATCH": {
        "en": "..or Create a New Rule From Scratch:",
        "da": "..eller opret en ny regel fra bunden:"
    },
    "CREATE_NEW_RULE": {
        "en": "Create New Rule",
        "da": "Opret ny regel"
    },
    "SELECT": {
        "en": "Select",
        "da": "Vælg"
    },
    "CONSENT_MANAGEMENT_PROVIDER_POPUP": {
        "en": "Consent Management Popup Provider Settings"
    },
    "NAME_OF_CMP": {
        "en": "Name of CMP"
    },
    "NAME_OF_CMP_HELP": {
        "en": "This is the name that will be displayed to the user when the popup is detected"
    },
    "DRAG_HINT": {
        "en": "Hint: Dragging while holding CTRL will copy the dragged subtree instead of moving it."
    },
    "DETECTORS": {
        "en": "Detectors:"
    },
    "DETECTORS_HELP": {
        "en": "Detectors are used to determine when a consent popup of this type has appeared on the screen. There can often be multiple detectors for the same popup if different variants exist (bottom bar, middle popup etc)"
    },
    "METHODS": {
        "en": "Methods:"
    },
    "METHODS_HELP": {
        "en": "Methods are executed when a popup has been detected by a detector. They serve different purposes such as opening and saving the consent configuration dialog."
    },
    "PRESENT_MATCHER": {
        "en": "presentMatcher"
    },
    "PRESENT_MATCHER_HELP": {
        "en": "This matcher determines whether a CMP popup is present on the page"
    },
    "SHOWING_MATCHER": {
        "en": "showingMatcher"
    },
    "SHOWING_MATCHER": {
        "en": "This matcher determines if a CMP popup is currently showing"
    },
    "TARGET": {
        "en": "target"
    },
    "TARGET_HELP": {
        "en": "The target of the selection"
    },
    "PARENT": {
        "en": "parent"
    },
    "PARENT_HELP": {
        "en": "An optional parent to search for before starting the search for target from there"
    },
    "SELECTOR": {
        "en": "selector"
    },
    "SELECTOR_HELP": {
        "en": "CSS selector that points to a DOM node"
    },
    "TEXT_FILTER": {
        "en": "textFilter"
    },
    "TEXT_FILTER_HELP": {
        "en": "A text filter applied to the found nodes based on their content"
    },
    "IFRAME_FILTER": {
        "en": "iframeFilter"
    },
    "IFRAME_FILTER_HELP": {
        "en": "Only trigger if inside an iframe"
    },
    "DISPLAY_FILTER": {
        "en": "displayFilter"
    },
    "DISPLAY_FILTER_HELP": {
        "en": "Only trigger if has display not 'none'"
    },
    "CHILD_FILTER": {
        "en": "ChildFilter"
    },
    "CHILD_FILTER_HELP": {
        "en": "Only trigger if child matching this DOM node selector is found"
    },
    "ACTIONS": {
        "en": "actions"
    },
    "ACTIONS_HELP": {
        "en": "Each of these actions will be performed in order"
    },
    "SELECTOR_HELP_LIST": {
        "en": "CSS selector that points to a list of DOM nodes"
    },
    "ACTION": {
        "en": "action"
    },
    "ACTION_HELP": {
        "en": "The action to perform for each of the targets found by the selector"
    },
    "TRUE_ACTION": {
        "en": "trueAction"
    },
    "TRUE_ACTION_HELP": {
        "en": "The action to execute if the selector is found"
    },
    "FALSE_ACTION": {
        "en": "falseAction"
    },
    "FALSE_ACTION_TEXT": {
        "en": "The action to execute if the selector is not found"
    },
    "SELECTOR_CLICK_HELP": {
        "en": "CSS selector that points to the DOM node that should be clicked"
    },
    "OPEN_IN_TAB": {
        "en": "openInTab"
    },
    "OPEN_IN_TAB_HELP": {
        "en": "If what is clicked is a link then optionally check this box to open it in a new tab"
    },
    "SELECTOR_HIDE_HELP": {
        "en": "CSS selector that points to the DOM node that should be hidden"
    },
    "DOM_NODE_SELECTOR": {
        "en": "DOM node selector"
    },
    "TARGET_SLIDE_HELP": {
        "en": "The target to perform a slide gesture on"
    },
    "DRAG_TARGET": {
        "en": "dragTarget"
    },
    "DRAG_TARGET_HELP": {
        "en": "The dom node to drag the slider to, x or y wise depending on axis."
    },
    "AXIS": {
        "en": "Axis"
    },
    "AXIS_HELP": {
        "en": "Direction of the slide"
    },
    "Y": {
        "en": "Y"
    },
    "X": {
        "en": "X"
    },
    "WAIT_FOR": {
        "en": "waitFor"
    },
    "WAIT_FOR_HELP": {
        "en": "The thing to wait for"
    },
    "RETRIES": {
        "en": "retries"
    },
    "RETRIES_HELP": {
        "en": "How many times to repeat the search"
    },
    "WAIT_TIME": {
        "en": "waitTime"
    },
    "WAIT_TIME_HELP": {
        "en": "How long to wait after each search"
    },
    "NEGATED": {
        "en": "negated"
    },
    "NEGATED_HELP": {
        "en": "If enabled, waits until dom selection no longer exists"
    }
};

class Language {
    static getString(key, subs) {
        //Find browser language
        let lang = navigator.language.substring(0, 2);

        //If no language, assume english
        if(lang == null) {
            lang = "en";
        }

        let result = "["+key+"-"+lang+"]";

        if(translations[key] != null) {
            const translation = translations[key];

            if(translation[lang] != null) {
                result = translation[lang];
            } else {
                console.warn("Missing translation ["+lang+"] for key: ", key, translation);
            }
        } else {
            console.warn("Unknown translation key:", key);
        }

        if(subs != null && Array.isArray(subs)) {
            for(let i = 1; i<subs.length+1; i++) {
                let sub = subs[i];
                result = result.replace("%"+i+"%", sub);
            }
        }

        return result;
    }

    static doLanguage(node) {
        if(node == null) {
            node = document.body;
        }

        console.log(node);

        const allTextNodes = document.createTreeWalker(node, NodeFilter.SHOW_TEXT);

        let regexp = /\[\[(\S+)\]\]/g;

        while(allTextNodes.nextNode()) {
            console.log(allTextNodes.currentNode);

            let matches = allTextNodes.currentNode.nodeValue.matchAll(regexp);

            for(let match of matches) {
                let translation = Language.getString(match[1], []);
                allTextNodes.currentNode.nodeValue = allTextNodes.currentNode.nodeValue.replace(match[0], translation);
            }
        }
    }

    static doAttributes(fragment) {
        let regexp = /\[\[(\S+)\]\]/g;

        fragment.querySelectorAll("*").forEach((node)=>{
            Array.from(node.attributes).forEach((attr)=>{
                let matches = attr.value.matchAll(regexp);

                for(let match of matches) {
                    let translation = Language.getString(match[1], []);
                    attr.value = attr.value.replace(match[0], translation);
                }
            });
        });
    }
}

window.addEventListener("DOMContentLoaded", ()=>{
    Language.doLanguage();
});
